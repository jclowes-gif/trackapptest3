import React, { useState, useEffect } from 'react';
import { 
  ChevronRight, 
  ChevronDown, 
  Plus, 
  Trash2, 
  CheckCircle, 
  Settings, 
  Clock, 
  Dumbbell,
  ClipboardList,
  XCircle,
  Trophy
} from 'lucide-react';

/**
 * Throws Prep Pro - A Drill Library and Session Organizer
 * * To host on GitHub:
 * 1. Ensure 'lucide-react' is installed: npm install lucide-react
 * 2. This file serves as the main entry point (App.jsx)
 * 3. Uses Tailwind CSS for styling
 */

const DRILL_LIBRARY = {
  "General Mobility": [
    { id: 'm1', name: 'Arm Circles', description: 'Small and large circles to loosen shoulders.', duration: 30 },
    { id: 'm2', name: 'Leg Swings', description: 'Lateral and linear swings for hip mobility.', duration: 30 },
    { id: 'm3', name: 'Torso Twists', description: 'Control rotations to warm up the core.', duration: 30 },
  ],
  "Shot Put Specific": [
    { id: 's1', name: 'Wrist Flips', description: 'Flipping the shot upward using only fingers/wrist.', focus: 'Release' },
    { id: 's2', name: 'Neck Press', description: 'Static holds or slight presses against the neck.', focus: 'Placement' },
    { id: 's3', name: 'Power Throw Balances', description: 'Hold the power position for 3-5 seconds.', focus: 'Balance' },
    { id: 's4', name: 'Stand Throws', description: 'Full power throws from a stationary position.', focus: 'Finish' },
    { id: 's5', name: 'Glide/Spin Step-ins', description: 'Working on the entry without the full throw.', focus: 'Entry' },
  ],
  "Discus Specific": [
    { id: 'd1', name: 'Bowling', description: 'Rolling the disc off the index finger.', focus: 'Release' },
    { id: 'd2', name: 'Spinning Cone Drills', description: 'Practice the entry turn while keeping arm back.', focus: 'Orbit' },
    { id: 'd3', name: 'Sky Hooks', description: 'Tossing the disc high to check flight and spin.', focus: 'Release' },
    { id: 'd4', name: 'Pivots / South Africans', description: 'Working the middle and finish of the throw.', focus: 'Rotation' },
    { id: 'd5', name: 'Full Spin Dry Runs', description: 'Shadow throwing without the implement.', focus: 'Footwork' },
  ]
};

// --- Sub-Components ---

const ProgressBar = ({ current, total }) => {
  const percentage = total === 0 ? 0 : Math.round((current / total) * 100);
  return (
    <div className="w-full bg-slate-200 h-2 rounded-full mt-2 overflow-hidden">
      <div 
        className="bg-green-500 h-full transition-all duration-500 ease-out"
        style={{ width: `${percentage}%` }}
      />
    </div>
  );
};

const DrillItem = ({ drill, onAdd }) => (
  <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100 group hover:border-indigo-200 transition-colors">
    <div className="flex-1">
      <h4 className="font-semibold text-slate-700">{drill.name}</h4>
      <p className="text-sm text-slate-500">{drill.description}</p>
      {drill.focus && (
        <span className="inline-block mt-1 text-[10px] uppercase tracking-wider font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">
          Focus: {drill.focus}
        </span>
      )}
    </div>
    <button 
      onClick={() => onAdd(drill)}
      className="ml-4 p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-700 hover:text-white transition-all shadow-sm"
      aria-label="Add to Routine"
    >
      <Plus className="w-5 h-5" />
    </button>
  </div>
);

const RoutineItem = ({ drill, onToggle, onRemove, onStartTimer, isActiveTimer }) => (
  <div className={`flex items-center justify-between p-4 rounded-xl border transition-all ${
    drill.completed ? 'bg-slate-50 border-slate-200 opacity-60' : 'bg-white border-slate-200 shadow-sm'
  }`}>
    <div className="flex items-center gap-4 flex-1">
      <button 
        onClick={() => onToggle(drill.instanceId)}
        className={`p-1 rounded-full transition-colors ${drill.completed ? 'text-green-600' : 'text-slate-300 hover:text-indigo-500'}`}
      >
        <CheckCircle className="w-8 h-8" fill={drill.completed ? 'currentColor' : 'none'} />
      </button>
      <div className="flex-1">
        <h4 className={`font-bold ${drill.completed ? 'line-through text-slate-500' : 'text-slate-800'}`}>
          {drill.name}
        </h4>
        <p className="text-xs text-slate-500 line-clamp-1">{drill.description}</p>
      </div>
    </div>
    
    <div className="flex items-center gap-1 ml-2">
      {drill.duration && !drill.completed && (
        <button 
          onClick={() => onStartTimer(drill.duration)}
          className={`p-2 rounded-lg transition-colors ${isActiveTimer ? 'bg-orange-500 text-white animate-pulse' : 'text-orange-600 hover:bg-orange-50'}`}
          title="Start Timer"
        >
          <Clock className="w-5 h-5" />
        </button>
      )}
      <button 
        onClick={() => onRemove(drill.instanceId)}
        className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
        title="Remove Drill"
      >
        <Trash2 className="w-5 h-5" />
      </button>
    </div>
  </div>
);

// --- Main Application ---

export default function App() {
  const [activeTab, setActiveTab] = useState('library');
  const [currentRoutine, setCurrentRoutine] = useState(() => {
    try {
      const saved = typeof window !== 'undefined' ? localStorage.getItem('throws-routine') : null;
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error("Failed to load routine from localStorage", error);
      return [];
    }
  });
  
  const [expandedCats, setExpandedCats] = useState(Object.keys(DRILL_LIBRARY));
  const [timeLeft, setTimeLeft] = useState(0);
  const [timerActive, setTimerActive] = useState(false);

  // Persistence
  useEffect(() => {
    try {
      if (typeof window !== 'undefined') {
        localStorage.setItem('throws-routine', JSON.stringify(currentRoutine));
      }
    } catch (error) {
      console.error("Failed to save routine to localStorage", error);
    }
  }, [currentRoutine]);

  // Timer Logic
  useEffect(() => {
    let interval = null;
    if (timerActive && timeLeft > 0) {
      interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
    } else if (timeLeft === 0) {
      setTimerActive(false);
    }
    return () => clearInterval(interval);
  }, [timerActive, timeLeft]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const handleAddDrill = (drill) => {
    setCurrentRoutine(prev => [...prev, { 
      ...drill, 
      instanceId: `${Date.now()}-${Math.random()}`, 
      completed: false 
    }]);
  };

  const handleToggleComplete = (id) => {
    setCurrentRoutine(prev => prev.map(d => 
      d.instanceId === id ? { ...d, completed: !d.completed } : d
    ));
  };

  const handleRemoveDrill = (id) => {
    setCurrentRoutine(prev => prev.filter(d => d.instanceId !== id));
  };

  const toggleCategory = (cat) => {
    setExpandedCats(prev => 
      prev.includes(cat) ? prev.filter(c => c !== cat) : [...prev, cat]
    );
  };

  const completedCount = currentRoutine.filter(d => d.completed).length;

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-24">
      {/* Persistent Header */}
      <header className="bg-indigo-700 text-white p-4 sticky top-0 z-10 shadow-md">
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="bg-white/20 p-2 rounded-lg">
              <Dumbbell className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold leading-none">Throws Prep</h1>
              <span className="text-[10px] text-indigo-200 uppercase tracking-widest font-bold">Training Assistant</span>
            </div>
          </div>
          
          <nav className="flex bg-indigo-900/40 rounded-xl p-1 border border-white/10">
            <button 
              onClick={() => setActiveTab('library')}
              className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all ${activeTab === 'library' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-100 hover:text-white'}`}
            >
              Library
            </button>
            <button 
              onClick={() => setActiveTab('routine')}
              className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'routine' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-100 hover:text-white'}`}
            >
              Session
              {currentRoutine.length > 0 && (
                <span className="bg-orange-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">
                  {currentRoutine.length - completedCount}
                </span>
              )}
            </button>
          </nav>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 pt-6">
        
        {/* Library View */}
        {activeTab === 'library' && (
          <div className="space-y-4">
            {Object.entries(DRILL_LIBRARY).map(([category, drills]) => (
              <section key={category} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <button 
                  onClick={() => toggleCategory(category)}
                  className="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-colors"
                >
                  <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                    {category}
                    <span className="text-slate-400 text-sm font-normal">({drills.length})</span>
                  </h3>
                  {expandedCats.includes(category) ? <ChevronDown className="text-slate-400"/> : <ChevronRight className="text-slate-400"/>}
                </button>
                
                {expandedCats.includes(category) && (
                  <div className="p-5 pt-0 grid gap-3">
                    {drills.map(drill => (
                      <DrillItem key={drill.id} drill={drill} onAdd={handleAddDrill} />
                    ))}
                  </div>
                )}
              </section>
            ))}
          </div>
        )}

        {/* Session View */}
        {activeTab === 'routine' && (
          <div className="space-y-6">
            {/* Status Card */}
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
              <div className="flex items-start justify-between mb-2">
                <div>
                  <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                    <ClipboardList className="text-indigo-600" />
                    Today's Routine
                  </h2>
                  <p className="text-slate-500 text-sm mt-1">
                    {currentRoutine.length === 0 
                      ? "Your list is empty." 
                      : completedCount === currentRoutine.length 
                        ? "Session complete! Great work." 
                        : "Focus on form and consistency."}
                  </p>
                </div>
                {timeLeft > 0 && (
                  <div className="flex flex-col items-end">
                    <div className="bg-orange-600 text-white px-4 py-2 rounded-xl font-mono text-2xl font-black shadow-lg shadow-orange-200">
                      {formatTime(timeLeft)}
                    </div>
                    <button 
                      onClick={() => { setTimeLeft(0); setTimerActive(false); }}
                      className="text-[10px] text-orange-600 font-bold uppercase mt-2 hover:underline"
                    >
                      Stop Timer
                    </button>
                  </div>
                )}
              </div>
              {currentRoutine.length > 0 && (
                <ProgressBar current={completedCount} total={currentRoutine.length} />
              )}
            </div>

            {/* Drill List */}
            <div className="space-y-3">
              {currentRoutine.map((drill) => (
                <RoutineItem 
                  key={drill.instanceId} 
                  drill={drill} 
                  onToggle={handleToggleComplete}
                  onRemove={handleRemoveDrill}
                  onStartTimer={(sec) => { setTimeLeft(sec); setTimerActive(true); }}
                  isActiveTimer={timerActive && timeLeft > 0}
                />
              ))}

              {currentRoutine.length === 0 && (
                <div className="text-center py-16 px-6 border-2 border-dashed border-slate-200 rounded-3xl bg-slate-50/50">
                  <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Plus className="text-slate-400 w-8 h-8" />
                  </div>
                  <h3 className="text-slate-800 font-bold text-lg">Empty Session</h3>
                  <p className="text-slate-400 text-sm max-w-xs mx-auto mb-6">You haven't added any drills to your workout yet. Browse the library to get started.</p>
                  <button 
                    onClick={() => setActiveTab('library')}
                    className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95"
                  >
                    Browse Library
                  </button>
                </div>
              )}
            </div>
            
            {currentRoutine.length > 0 && (
              <div className="flex flex-col gap-3">
                 {completedCount === currentRoutine.length && (
                  <div className="bg-green-100 border border-green-200 p-4 rounded-xl flex items-center gap-3 text-green-800 animate-bounce">
                    <Trophy className="w-6 h-6 shrink-0" />
                    <span className="font-bold">Session Complete! Ready for the ring?</span>
                  </div>
                )}
                <button 
                  onClick={() => {
                    if(window.confirm("Clear your entire session?")) setCurrentRoutine([]);
                  }}
                  className="w-full py-4 text-slate-400 text-sm font-bold flex items-center justify-center gap-2 hover:text-red-500 transition-colors"
                >
                  <XCircle className="w-4 h-4" />
                  Reset Session Data
                </button>
              </div>
            )}
          </div>
        )}
      </main>

      {/* Mobile Bottom Nav */}
      <footer className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-slate-200 p-3 flex justify-around items-center md:hidden z-20">
         <button 
          onClick={() => setActiveTab('library')} 
          className={`flex flex-col items-center p-2 rounded-xl transition-all ${activeTab === 'library' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}
         >
            <Settings className="w-6 h-6" />
            <span className="text-[10px] font-bold uppercase tracking-tight">Library</span>
         </button>
         <button 
          onClick={() => setActiveTab('routine')} 
          className={`flex flex-col items-center p-2 rounded-xl transition-all relative ${activeTab === 'routine' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}
         >
            <ClipboardList className="w-6 h-6" />
            <span className="text-[10px] font-bold uppercase tracking-tight">Session</span>
            {currentRoutine.length > 0 && (
               <span className="absolute top-1 right-1 w-2 h-2 bg-orange-500 rounded-full border-2 border-white"></span>
            )}
         </button>
      </footer>
    </div>
  );
}